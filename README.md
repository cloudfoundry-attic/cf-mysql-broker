# CF MySQL Broker

This is the broker for a new Cloud Foundry MySQL service that demonstrates the v2 Services API.

### The new services API is still in progress and may change at any time. Do not build a broker against this API.

## API

During development you can inspect the current API routes:

```
$ rake routes
                             Prefix Verb   URI Pattern                                                               Controller#Action
                         v2_catalog GET    /v2/catalog(.:format)                                                     v2/catalogs#show
v2_service_instance_service_binding PATCH  /v2/service_instances/:service_instance_id/service_bindings/:id(.:format) v2/service_bindings#update
                                    PUT    /v2/service_instances/:service_instance_id/service_bindings/:id(.:format) v2/service_bindings#update
                                    DELETE /v2/service_instances/:service_instance_id/service_bindings/:id(.:format) v2/service_bindings#destroy
                v2_service_instance PATCH  /v2/service_instances/:id(.:format)                                       v2/service_instances#update
                                    PUT    /v2/service_instances/:id(.:format)                                       v2/service_instances#update
                                    DELETE /v2/service_instances/:id(.:format)                                       v2/service_instances#destroy
```

## Local usage

NOTE: At the time of writing this section, there was no way to select a service plan from the calalog where creating a service.

In one terminal:

```
$ bundle
$ rake db:create:all
$ bin/rails s
```

In another terminal:

```
$ curl http://cc:secret@localhost:3000/v2/catalog
```

To see the output in a pretty format:

```
$ gem install jazor
$ curl http://cc:secret@localhost:3000/v2/catalog | jazor
```

Outputs:

``` json
{
  "services": [
    {
      "id": "cf-mysql-1",
      "name": "cf-mysql2",
      "description": "Cloud Foundry MySQL",
      "tags": [
        "mysql",
        "relational"
      ],
      "metadata": {
        "listing": {
          "imageUrl": null,
          "blurb": "MySQL service for application development and testing"
        }
      },
      "plans": [
        {
          "id": "cf-mysql-plan-1",
          "name": "free2",
          "description": "Free Trial",
          "metadata": {
            "cost": 0.0,
            "bullets": [
              {
                "content": "Shared MySQL server"
              },
              {
                "content": "100 MB storage"
              },
              {
                "content": "40 concurrent connections"
              }
            ]
          }
        }
      ],
      "bindable": true
    }
  ]
}
```

This output matches the plans described in `config/settings.yml`.

To create a service instance:

```
$ curl -i -X PUT http://cc:secret@localhost:3000/v2/service_instances/my-own-id-1 -d ''
HTTP/1.1 201 Created 
...

{"dashboard_url":"http://fake.dashboard.url"}
```

As you can see, the service instance ID (`my-own-id-1` above) is designated by the called, rather than the service broker.

To then bind a service instance:

```
curl -i -X PUT http://cc:secret@localhost:3000/v2/service_instances/my-own-id-1/service_bindings/my-binding-1 -d ''
HTTP/1.1 201 Created
...

{"credentials":{"hostname":"localhost","port":3306,"name":"cf_my_own_id_1","username":"eKDT9XsB0csSjWfe","password":"y4ZOo3pQXwt4HuHC","uri":"mysql://eKDT9XsB0csSjWfe:y4ZOo3pQXwt4HuHC@localhost:3306/cf_my_own_id_1?reconnect=true","jdbcUrl":"jdbc:mysql://eKDT9XsB0csSjWfe:y4ZOo3pQXwt4HuHC@localhost:3306/cf_my_own_id_1"}}
```

The response includes all the details required to connect and authenticate to the running MySQL server database.

As you can see, the service binding ID (`my-binding-1` above) is designated by the caller, rather than generated by the service broker.

To delete the service binding and service instance:

```
curl -i -X DELETE http://cc:secret@localhost:3000/v2/service_instances/my-own-id-1/service_bindings/my-binding-1
HTTP/1.1 204 No Content 

$ curl -i -X DELETE http://cc:secret@localhost:3000/v2/service_instances/my-own-id-1
HTTP/1.1 204 No Content 
```